import requests
import time
import random
import os
import datetime


'''
ä½¿ç”¨è¯´æ˜è§æ¸¸ä¾ ç­¾åˆ°
'''

# å®šä¹‰å¸¸é‡ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§
BASE_URL_API3 = "https://api3.ali213.net"
BASE_URL_NEWAPI = "https://newapi.ali213.net"
HEADER_HOST = "api3.ali213.net"
USER_AGENT = "okhttp/3.10.0"

# é€šç”¨çš„è¯·æ±‚å‡½æ•°ï¼Œå‡å°‘ä»£ç é‡å¤
def make_request(url, headers, params):
    try:
        response = requests.get(url, headers=headers, params=params)
        response.raise_for_status()  # æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
        return response.json()
    except requests.RequestException as e:
        print(f"è¯·æ±‚å‡ºé”™: {e}")
        return None
    except ValueError as e:
        print(f"è§£æJSONå‡ºé”™: {e}")
        return None

# å‘é€è·å¾—é˜…è¯»é‡‘å¸è¯·æ±‚
def read(ID, token, headers,lable):
    marklog_params = {
        "token": token,
        "channelID": "1",
        "entityID": ID,
        "id": ""
    }
    # å‘é€ marklog è¯·æ±‚
    make_request(f"{BASE_URL_API3}/feedearn/marklog", headers, marklog_params)
    # éšæœºä¼‘çœ 
    time.sleep(random.randint(5, 9))

    readresource_params = {
        "token": token,
        "channelID": "1",
        "entityID": ID
    }
    # å‘é€ readresource è¯·æ±‚
    print(lable)
    res = make_request(f"{BASE_URL_API3}/feedearn/readresource", headers, readresource_params)
    if res and 'status' in res and res['status'] == 1:
        msg = res['msg']
        print(f'[é˜…è¯»æˆåŠŸ]ï¼šè·å¸{msg}')
    elif res:
        msg = res['msg']
        print(f'{msg}ğŸ˜’')

# è·å–æ–‡ç« id
def getid(token, headers):

    # è·å–æ¨èåˆ—è¡¨
    res = make_request(f"{BASE_URL_NEWAPI}/app/v1/recommendList", headers, recommend_params)
    if res:
        try:
            sub_list = res["data"]["list"][0]["subList"]
            for item in sub_list[:3]:
                ID = item['resourceId']
                lable = item['label']
                read(ID, token, headers,lable)

            main_list = res["data"]["list"]
            for item in main_list[:10]:
                lable = item['label']
                #print(lable)
                ID = item['resourceId']
                read(ID, token, headers,lable)
        except (KeyError, IndexError) as e:
            print(f"è§£ææ¨èåˆ—è¡¨å‡ºé”™: {e}")
        next_confirm = str(res['data']['confirmNo'])
        next_lastId = str(res["data"]["list"][-1]["createTime"])
        next_page = str(int(res['data']['pageNo'])+1)
        recommend_params['pageNo'] = next_page
        recommend_params['confirmNo'] = next_confirm
        recommend_params['lastId'] = next_lastId
if __name__ == "__main__":
    CKS = os.getenv('YXRCCK')
    if not CKS:
        print("æœªæ‰¾åˆ°ç¯å¢ƒå˜é‡ YXRCCKï¼Œè¯·è®¾ç½®è¯¥å˜é‡ã€‚")
    else:
        CKL = CKS.split("@")
        print(f"ã€æ¸¸ä¾ é˜…è¯»ã€‘å…±æ£€æµ‹åˆ°{len(CKL)}ä¸ªè´¦å·")
        print(f"==========================================")
        print(f"===============é¼ é¼ è‡ªç”¨ç‰ˆğŸ¥±===============")
        for index, CK in enumerate(CKL, start=1):
            print(f"========ã€è´¦å·{index}ã€‘å¼€å§‹è¿è¡Œè„šæœ¬========")
            token = CK.split("#")[0]
            headers = {
                "Host": HEADER_HOST,
                "accept-encoding": "gzip",
                "user-agent": USER_AGENT
            }
            recommend_params = {
                    "navId": "1",
                    "pageNo": '1',
                    "pageNum": "10",
                    "lastId": "",
                    "keyword": "",
                    "confirmNo": "0"
            }
            # é˜…è¯»æ–‡ç« 
            for i in range(20):
                getid(token, headers)
                print(f'ç¬¬{i + 1}é¡µè¯»')
            if index < len(CKL):
                print("å»¶è¿Ÿä¸€å°ä¼š,å‡†å¤‡è·‘ä¸‹ä¸€ä¸ªè´¦å·ğŸ¥³")